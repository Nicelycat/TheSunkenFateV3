<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FATE V3 - Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="media/logo.svg" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap");
      
      :root {
        --primary-color: #0f3460;
        --secondary-color: #1e5f8e;
        --accent-color: #3d84b8;
        --bg-2-color: #16213e;
        --bg-color: #0a0a23;
        --text-color: #e0e0e0;
        --text-secondary-color: #a0c8e6;
        --text-placeholder-color: #5a7a9c;
        --border-color: #2c3e50;
        --font-family: "Poppins", sans-serif;
        --font-size: 16px;
        --border-radius: 12px;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: var(--font-family);
        font-size: var(--font-size);
        background-image: 
          radial-gradient(circle at 10% 20%, rgba(15, 52, 96, 0.1) 0%, transparent 20%),
          radial-gradient(circle at 90% 80%, rgba(61, 132, 184, 0.1) 0%, transparent 20%);
      }

      /* Navigation bar styles */
      .nav-glass {
        background: rgba(22, 33, 62, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(61, 132, 184, 0.3);
      }

      .nav-link {
        transition: all 0.2s ease;
      }

      .nav-link:hover {
        color: #ffffff;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
      }

      /* Panic Button Styles - Now in Navbar */
      .panic-button {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        white-space: nowrap;
      }

      .panic-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .panic-button:active {
        transform: scale(0.95);
      }

      .panic-button i {
        font-size: 14px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.1); }
      }

      /* Mobile adjustment for panic button */
      @media (max-width: 640px) {
        .panic-button {
          padding: 8px 12px;
          font-size: 11px;
        }
        .panic-button span {
          display: none;
        }
        .panic-button i {
          font-size: 16px;
          margin: 0;
        }
      }

      .game-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 35, 0.95);
        z-index: 9998;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .game-popup-container {
        width: 95%;
        height: 95%;
        max-width: 1400px;
        max-height: 900px;
        background: var(--bg-2-color);
        border-radius: var(--border-radius);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(15, 52, 96, 0.5);
        border: 1px solid rgba(61, 132, 184, 0.3);
      }

      .game-popup-header {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, var(--bg-2-color) 0%, #1a2a4a 100%);
      }

      .game-popup-title {
        color: var(--text-color);
        font-size: 18px;
        font-weight: 600;
        flex: 1;
        text-align: center;
        text-shadow: 0 0 8px rgba(224, 224, 224, 0.5);
      }

      .game-popup-close,
      .game-popup-fullscreen {
        background: var(--border-color);
        border: none;
        color: var(--text-color);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 18px;
      }

      .game-popup-close:hover,
      .game-popup-fullscreen:hover {
        background: var(--secondary-color);
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(30, 95, 142, 0.5);
        color: #ffffff;
      }

      .game-popup-content {
        flex: 1;
        position: relative;
        background: var(--bg-color);
      }

      .game-popup-content iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .bg-gray-900 {
        background-color: var(--bg-color) !important;
      }

      .text-white {
        color: var(--text-color) !important;
        text-shadow: 0 0 5px rgba(224, 224, 224, 0.3);
      }

      .bg-gray-800 {
        background-color: var(--bg-2-color) !important;
      }

      .text-gray-400 {
        color: var(--text-secondary-color) !important;
      }

      .border-gray-700 {
        border-color: var(--border-color) !important;
      }

      .focus\:border-purple-500:focus {
        border-color: var(--primary-color) !important;
      }

      .text-purple-500 {
        color: var(--primary-color) !important;
        text-shadow: 0 0 8px rgba(15, 52, 96, 0.4);
      }

      .text-gray-500 {
        color: var(--text-placeholder-color) !important;
      }

      .text-red-500 {
        color: var(--accent-color) !important;
        text-shadow: 0 0 5px rgba(61, 132, 184, 0.3);
      }

      .text-green-500 {
        color: var(--secondary-color) !important;
      }

      .text-yellow-500 {
        color: #64b5f6 !important;
        text-shadow: 0 0 5px rgba(100, 181, 246, 0.3);
      }

      .text-blue-500 {
        color: var(--primary-color) !important;
      }

      .bg-red-500 {
        background-color: var(--accent-color) !important;
        box-shadow: 0 0 5px rgba(61, 132, 184, 0.3);
      }

      .bg-green-500 {
        background-color: var(--secondary-color) !important;
      }

      .bg-yellow-500 {
        background-color: #64b5f6 !important;
        box-shadow: 0 0 5px rgba(100, 181, 246, 0.3);
      }

      .bg-blue-500 {
        background-color: var(--primary-color) !important;
      }

      .shadow-purple-500\/50 {
        box-shadow: 0 0 20px rgba(15, 52, 96, 0.5) !important;
      }

      input:focus {
        box-shadow: 0 0 10px rgba(15, 52, 96, 0.3) !important;
      }

      a:hover {
        color: #ffffff !important;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
      }

      button:hover {
        color: #ffffff !important;
      }

      /* White Aura Effect for Main Title */
      h1 span {
        text-shadow: 
          0 0 10px rgba(255, 255, 255, 0.7),
          0 0 20px rgba(255, 255, 255, 0.5),
          0 0 30px rgba(255, 255, 255, 0.3);
      }

      /* Additional glow for interactive elements */
      .hover\:scale-105:hover {
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
      }

      /* Add padding to account for fixed nav */
      body {
        padding-top: 80px;
      }

      /* Lazy loading placeholder */
      .game-card {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      
      .game-card.loading {
        opacity: 0.6;
      }

      .game-image {
        transition: opacity 0.3s ease;
      }
      
      .game-image.loading {
        opacity: 0;
      }

      /* Virtual scroll optimization */
      .game-grid {
        contain: layout style paint;
      }

      /* Search loading indicator */
      .search-loading {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Cache indicator */
      .cache-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(46, 213, 115, 0.2);
        color: #2ed573;
        border: 1px solid rgba(46, 213, 115, 0.3);
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation Bar -->
    <nav class="nav-glass fixed top-0 left-0 right-0 z-50 px-6 py-3">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <!-- Panic Button moved to navbar left side -->
          <button class="panic-button" onclick="window.location.href='https://clever.com'" title="Emergency Exit - Go to Clever">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Panic</span>
          </button>
          
          <div class="flex items-center gap-3 border-l border-gray-700 pl-4">
            <img src="media/logo.svg" alt="FATE V3" class="w-10 h-10" style="filter: drop-shadow(0 0 8px rgba(255,255,255,0.5));">
            <span class="text-xl font-bold text-white">FATE V3</span>
          </div>
        </div>
        <div class="flex gap-6 items-center">
          <a href="index.html" class="nav-link text-blue-300 hover:text-white font-medium flex items-center gap-2">
            <i class="fas fa-home"></i> Home
          </a>
          <a href="https://fatev2.vercel.app/apps.html" class="nav-link text-blue-300 hover:text-white font-medium flex items-center gap-2">
            <i class="fas fa-th-large"></i> Apps
          </a>
          <a href="https://discord.gg/MfEnRxxxA" target="_blank" class="nav-link text-blue-300 hover:text-white font-medium">
            <i class="fab fa-discord"></i> Discord
          </a>
        </div>
      </div>
    </nav>

    <div x-data="gamesApp()" x-init="init()">
      <header class="p-6 text-center">
        <h1 class="text-4xl font-bold">
          <span>FATE V3 Games</span>
        </h1>
        <p class="text-center mt-2 text-sm" style="color: var(--text-secondary-color);">FATE Browser is coming soon, you can watch tiktok on it :)</p>
      </header>

      <main class="container mx-auto p-4 max-w-7xl">
        <div class="mb-6 space-y-4">
          <div class="relative">
            <input
              type="text"
              x-model="searchQuery"
              @input="debouncedSearch()"
              :placeholder="searchPlaceholder"
              :class="{'search-loading': isSearching}"
              class="w-full px-4 py-3 bg-gray-800 text-white rounded-2xl border border-gray-700 focus:outline-none focus:border-purple-500 transition"
            />
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
              <span x-show="usingCache" class="cache-badge">CACHED</span>
              <i x-show="isSearching" class="fas fa-spinner fa-spin text-gray-400"></i>
            </div>
          </div>

          <div class="flex justify-between items-center text-sm text-gray-400 px-2">
            <span x-text="filteredGames.length + ' games available'"></span>
            <button @click="clearCache()" class="text-xs hover:text-white transition" x-show="usingCache">
              <i class="fas fa-sync-alt mr-1"></i>Refresh Data
            </button>
          </div>
        </div>

        <div x-show="loading" class="text-center py-12">
          <i class="fa-solid fa-spinner fa-spin text-4xl text-purple-500"></i>
          <p class="mt-4 text-gray-400">Loading games...</p>
        </div>

        <div
          x-show="!loading && filteredGames.length === 0"
          class="text-center py-12"
        >
          <i class="fa-solid fa-circle-exclamation text-4xl text-gray-500"></i>
          <p class="mt-4 text-gray-400">No games found.</p>
        </div>

        <div
          x-show="!loading && filteredGames.length > 0"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 game-grid"
          id="gamesGrid"
        >
          <template x-for="(game, index) in visibleGames" :key="game.id || index">
            <div
              class="bg-gray-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-purple-500/50 transition-all hover:scale-105 cursor-pointer game-card"
              :data-index="index"
              :id="'game-' + index"
              @click="openGame(game)"
            >
              <div class="relative aspect-square bg-gray-700 overflow-hidden">
                <img
                  :data-src="getGameImage(game)"
                  :alt="game.name"
                  class="w-full h-full object-cover game-image loading"
                  loading="lazy"
                  @load="$event.target.classList.remove('loading')"
                />
                <div class="absolute top-2 left-2 flex flex-col gap-1">
                  <span
                    x-show="game.top"
                    class="bg-red-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-fire"></i> HOT
                  </span>
                  <span
                    x-show="game.new"
                    class="bg-green-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-sparkles"></i> NEW
                  </span>
                  <span
                    x-show="game.exp"
                    class="bg-yellow-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-vial"></i> EXP
                  </span>
                  <span
                    x-show="game.updated"
                    class="bg-blue-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-sparkles"></i> UPDATED
                  </span>
                </div>
              </div>

              <div class="p-3">
                <p
                  class="text-sm font-semibold text-center truncate"
                  x-text="game.name"
                ></p>
              </div>
            </div>
          </template>
        </div>

        <!-- Load More Trigger -->
        <div 
          x-show="hasMoreGames" 
          class="text-center py-8"
          id="loadMoreTrigger"
        >
          <button 
            @click="loadMore()" 
            class="px-6 py-3 bg-gray-800 rounded-xl hover:bg-gray-700 transition flex items-center gap-2 mx-auto"
            :disabled="loadingMore"
          >
            <i x-show="loadingMore" class="fas fa-spinner fa-spin"></i>
            <span x-text="loadingMore ? 'Loading...' : 'Load More Games'"></span>
          </button>
        </div>
      </main>

      <div
        class="game-popup-overlay"
        x-show="popupOpen"
        @click.self="closePopup()"
      >
        <div class="game-popup-container">
          <div class="game-popup-header">
            <div style="width: 36px"></div>
            <div
              class="game-popup-title"
              x-text="currentGame?.name || 'Loading...'"
            ></div>
            <div style="display: flex; flex-direction: row; gap: 4px">
              <button class="game-popup-fullscreen" @click="fullscreenPopup()">
                <i class="fa-solid fa-expand"></i>
              </button>
              <button class="game-popup-close" @click="closePopup()">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
          <div class="game-popup-content">
            <iframe x-ref="gameFrame"></iframe>
          </div>
        </div>
      </div>

      <div
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        x-show="showWarningModal"
        x-transition
      >
        <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4 border" style="border-color: #0f3460;">
          <h2 class="text-xl font-bold mb-4" style="color: #e0e0e0;">Important Notice</h2>
          <p class="text-gray-300 mb-4">
            Welcome to FATE V3! Remember to sync periodically to keep
            the games list updated and ensure all games continue working properly.
          </p>
          <button
            @click="showWarningModal = false; localStorage.setItem('warningModalShown', 'true');"
            class="hover:bg-purple-700 px-4 py-2 rounded-xl"
            style="background-color: #0f3460; color: #ffffff; font-weight: bold;"
          >
            Got it!
          </button>
        </div>
      </div>

      <!-- VISITOR COUNTER FOOTER -->
      <footer class="mt-12 py-6 text-center text-gray-500 text-sm">
        <div style="margin-bottom: 15px; padding: 15px; background: rgba(15, 52, 96, 0.2); border-radius: 8px; display: inline-block;">
          <span style="color: #e0e0e0; font-size: 16px; font-weight: 600;">üë• Total Visitors: </span>
          <a href='https://www.free-counters.org/' style="display: none;">https://www.free-Counters.org</a>
          <script type='text/javascript' src='https://www.freevisitorcounters.com/auth.php?id=aac3697a17827feb76b9c30b1d439798f92b3329'></script>
          <script type="text/javascript" src="https://www.freevisitorcounters.com/en/home/counter/1486140/t/3"></script>
        </div>
        <p style="margin-top: 10px;">FATE V3 - Made with ‚ù§Ô∏è</p>
      </footer>
    </div>

    <script>
      const cdnUrl = "https://mathcenter.space";
      const cdnUrl2 = "https://corsproxy.io/?url=";
      const CACHE_KEY = 'fate_games_cache';
      const CACHE_DURATION = 1000 * 60 * 30; // 30 minutes
      const GAMES_PER_PAGE = 24; // Virtual scrolling batch size

      function gamesApp() {
        return {
          allGames: [],
          filteredGames: [],
          visibleGames: [],
          searchQuery: "",
          searchPlaceholder: "Search for games",
          loading: true,
          loadingMore: false,
          popupOpen: false,
          currentGame: null,
          showWarningModal: true,
          usingCache: false,
          isSearching: false,
          searchTimeout: null,
          currentPage: 0,
          hasMoreGames: false,
          imageObserver: null,

          async init() {
            this.showWarningModal =
              !window.location.search.includes("nomodal") &&
              !localStorage.getItem("warningModalShown");

            console.log(
              "%cFATE%c V3 - Optimized Loading...",
              "font-size: 16px; background-color: #0f3460; border-radius: 5px 0 0 5px; padding: 4px; font-weight: bold;",
              "font-size: 16px; background-color: #0a0a23; font-weight: bold; padding: 4px; border-radius: 0 5px 5px 0;"
            );

            // Initialize intersection observer for lazy loading images
            this.initImageObserver();
            
            // Try to load from cache first for instant display
            const cached = this.getCachedGames();
            if (cached) {
              this.allGames = cached;
              this.filteredGames = cached;
              this.updateVisibleGames();
              this.usingCache = true;
              this.loading = false;
              
              // Silently refresh in background
              this.refreshGamesInBackground();
            } else {
              await this.loadGames();
            }

            // Setup intersection observer for infinite scroll
            this.initInfiniteScroll();
          },

          initImageObserver() {
            // Use Intersection Observer for lazy loading images
            this.imageObserver = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  const img = entry.target;
                  const src = img.getAttribute('data-src');
                  if (src) {
                    // Create a new image to preload
                    const preloadImg = new Image();
                    preloadImg.onload = () => {
                      img.src = src;
                      img.removeAttribute('data-src');
                    };
                    preloadImg.src = src;
                    this.imageObserver.unobserve(img);
                  }
                }
              });
            }, {
              rootMargin: '50px 0px', // Start loading 50px before viewport
              threshold: 0.01
            });
          },

          initInfiniteScroll() {
            const loadMoreTrigger = document.getElementById('loadMoreTrigger');
            if (loadMoreTrigger) {
              const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                  if (entry.isIntersecting && this.hasMoreGames && !this.loadingMore) {
                    this.loadMore();
                  }
                });
              }, { threshold: 0.1 });
              
              observer.observe(loadMoreTrigger);
            }
          },

          getCachedGames() {
            try {
              const cached = localStorage.getItem(CACHE_KEY);
              if (!cached) return null;
              
              const { data, timestamp } = JSON.parse(cached);
              const age = Date.now() - timestamp;
              
              // Return null if cache is expired
              if (age > CACHE_DURATION) {
                localStorage.removeItem(CACHE_KEY);
                return null;
              }
              
              return data;
            } catch (e) {
              console.error('Cache read error:', e);
              return null;
            }
          },

          setCachedGames(data) {
            try {
              const cache = {
                data: data,
                timestamp: Date.now()
              };
              localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) {
              console.error('Cache write error:', e);
            }
          },

          clearCache() {
            localStorage.removeItem(CACHE_KEY);
            this.usingCache = false;
            this.loadGames();
          },

          async refreshGamesInBackground() {
            try {
              const freshData = await this.fetchGamesData();
              if (freshData.length > 0) {
                this.allGames = freshData;
                this.applyFilters();
                this.setCachedGames(freshData);
                this.usingCache = false;
              }
            } catch (error) {
              console.error('Background refresh failed:', error);
            }
          },

          async loadGames() {
            this.loading = true;
            try {
              const data = await this.fetchGamesData();
              this.allGames = data;
              this.filteredGames = data;
              this.updateVisibleGames();
              this.setCachedGames(data);
              this.usingCache = false;
            } catch (error) {
              console.error("Error loading games:", error);
              // If fetch fails and we have no data, show error state
              if (this.allGames.length === 0) {
                this.searchPlaceholder = "Failed to load games";
              }
            } finally {
              this.loading = false;
            }
          },

          async fetchGamesData() {
            // Use Promise.race for timeout protection
            const timeout = new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Request timeout')), 10000)
            );

            const fetchPromise = Promise.allSettled([
              fetch("./json/games.json").then((r) => r.json()),
              fetch(cdnUrl2 + encodeURIComponent("https://mathcenter.space/cdn/all")).then((r) => r.json()),
            ]);

            const responses = await Promise.race([fetchPromise, timeout]);
            
            const games = responses
              .filter((r) => r.status === "fulfilled")
              .flatMap((r) => r.value);

            // Add unique IDs for virtual scrolling
            return games.map((game, index) => ({
              ...game,
              id: game.id || `game-${index}-${Date.now()}`
            }));
          },

          debouncedSearch() {
            this.isSearching = true;
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
              this.applyFilters();
              this.isSearching = false;
            }, 300); // 300ms debounce
          },

          applyFilters() {
            let filtered = this.allGames;

            if (this.searchQuery) {
              const query = this.searchQuery.toLowerCase();
              filtered = filtered.filter((game) =>
                game.name.toLowerCase().includes(query)
              );
            }

            filtered = [...filtered].sort((a, b) => {
              if (a.name === "Request a game") return -1;
              if (b.name === "Request a game") return 1;
              if (a.new && !b.new) return -1;
              if (!a.new && b.new) return 1;
              if (a.top && !b.top) return -1;
              if (!a.top && b.top) return 1;
              return 0;
            });

            this.filteredGames = filtered;
            this.currentPage = 0;
            this.updateVisibleGames();
            this.searchPlaceholder = `Search for ${filtered.length} game${filtered.length !== 1 ? "s" : ""}`;
          },

          updateVisibleGames() {
            const start = 0;
            const end = (this.currentPage + 1) * GAMES_PER_PAGE;
            this.visibleGames = this.filteredGames.slice(start, end);
            this.hasMoreGames = end < this.filteredGames.length;
            
            // Observe new images after DOM update
            this.$nextTick(() => {
              this.observeImages();
            });
          },

          observeImages() {
            // Observe all images with data-src for lazy loading
            const images = document.querySelectorAll('img[data-src]');
            images.forEach(img => this.imageObserver.observe(img));
          },

          loadMore() {
            if (this.loadingMore || !this.hasMoreGames) return;
            this.loadingMore = true;
            
            // Simulate async for smooth UI
            setTimeout(() => {
              this.currentPage++;
              const start = this.currentPage * GAMES_PER_PAGE;
              const end = start + GAMES_PER_PAGE;
              const newGames = this.filteredGames.slice(start, end);
              this.visibleGames = [...this.visibleGames, ...newGames];
              this.hasMoreGames = end < this.filteredGames.length;
              this.loadingMore = false;
              
              this.$nextTick(() => {
                this.observeImages();
              });
            }, 100);
          },

          getGameImage(game) {
            if (game.image?.startsWith("https://")) {
              return game.image;
            }
            if (game.proxy) {
              return cdnUrl + `/media/games/${game.image}`;
            } else {
              const firstSegment = game.url?.split("/")[0] || "";
              return cdnUrl + `/cdn/${firstSegment}/${game.image}`;
            }
          },

          async openGame(game) {
            console.log("Opening game:", game.name);
            this.currentGame = game;
            this.popupOpen = true;

            await this.$nextTick();
            const iframe = this.$refs.gameFrame;
            console.log("Iframe ref:", iframe);

            if (game.url?.includes("jsdelivr")) {
              try {
                const response = await fetch(game.url);
                const html = await response.text();
                iframe.contentDocument.open();
                iframe.contentDocument.write(html);
                iframe.contentDocument.close();
              } catch (error) {
                console.error("Error loading jsdelivr content:", error);
              }
            } else if (!game.proxy) {
              iframe.src = cdnUrl + `/cdn/${game.url}/`;
            } else {
              iframe.src = game.url;
            }
          },

          closePopup() {
            console.log("Closing popup");
            this.popupOpen = false;
            this.currentGame = null;

            const iframe = this.$refs.gameFrame;
            if (iframe) {
              iframe.src = "about:blank";
            }
          },

          fullscreenPopup() {
            const iframe = this.$refs.gameFrame;
            if (iframe.requestFullscreen) {
              iframe.requestFullscreen();
            } else if (iframe.mozRequestFullScreen) {
              iframe.mozRequestFullScreen();
            } else if (iframe.webkitRequestFullscreen) {
              iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
              iframe.msRequestFullscreen();
            }
          },
        };
      }
    </script>
  </body>
</html>
